<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel de Administraci√≥n</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    rel="stylesheet"
  >
  <style>
    body { background-color: #f8f9fa; }
    .card-img-top { height: 200px; object-fit: contain; }
    .btn-custom { transition: all 0.3s ease-in-out; border-radius: 8px; }
    .btn-custom:hover { transform: scale(1.05); box-shadow: 0 4px 10px rgba(0,0,0,0.15); }
    .top-buttons { display: flex; justify-content: space-between; margin-bottom: 20px; }
    .form-group { margin-bottom: 1rem; }
    .form-group label { font-weight: bold; display: block; margin-bottom: .25rem; }
    .form-control { width: 100%; padding: .5rem; border: 1px solid #ccc; border-radius: .25rem; }
    .text-error { color: #c00; margin-top: .5rem; }
  </style>
</head>
<body class="bg-light">
  <div class="container mt-4">

    <div class="top-buttons">
      <a href="peces.html" class="btn btn-outline-primary btn-custom">‚Üê Regresar a galer√≠a</a>
      <button id="btn-logout" class="btn btn-outline-danger btn-custom">Cerrar sesi√≥n</button>
    </div>

    <h1 class="text-center text-success mb-4">Panel de Administraci√≥n üõ†Ô∏è</h1>

    <div class="text-center mb-3">
      <button
        id="btn-agregar"
        class="btn btn-success btn-custom"
        data-bs-toggle="modal"
        data-bs-target="#modalAgregarPez">
        + Agregar nuevo pez
      </button>
    </div>

    <!-- Modal Agregar Pez -->
    <div class="modal fade" id="modalAgregarPez" tabindex="-1">
      <div class="modal-dialog"><div class="modal-content">
        <form id="form-agregar">
          <div class="modal-header">
            <h5 class="modal-title">Agregar Pez</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label for="add-nombre_comun">Nombre com√∫n</label>
              <input id="add-nombre_comun" name="nombre_comun" type="text"
                     placeholder="Ej. Boquichico" class="form-control" required>
            </div>
            <div class="form-group">
              <label for="add-nombre_cientifico">Nombre cient√≠fico</label>
              <input id="add-nombre_cientifico" name="nombre_cientifico" type="text"
                     placeholder="Ej. Prochilodus nigricans" class="form-control" required>
            </div>
            <div class="form-group">
              <label for="add-familia">Familia</label>
              <input id="add-familia" name="familia" type="text"
                     placeholder="Ej. Prochilodontidae" class="form-control" required>
            </div>
            <div class="form-group">
              <label for="add-alimentacion">Alimentaci√≥n</label>
              <input id="add-alimentacion" name="alimentacion" type="text"
                     placeholder="Ej. Omn√≠vora" class="form-control">
            </div>
            <div class="form-group">
              <label for="add-estado_conservacion">Estado de conservaci√≥n</label>
              <input id="add-estado_conservacion" name="estado_conservacion" type="text"
                     placeholder="Ej. Preocupaci√≥n menor" class="form-control">
            </div>
            <div class="form-group">
              <label for="add-imagen">Imagen</label>
              <input id="add-imagen" name="imagen" type="file"
                     class="form-control" accept="image/*" required>
            </div>
            <p id="agregar-msg" class="text-error"></p>
          </div>
          <div class="modal-footer">
            <button class="btn btn-success w-100" type="submit">Crear</button>
          </div>
        </form>
      </div></div>
    </div>

    <!-- Modal Editar Pez -->
    <div class="modal fade" id="modalEditar" tabindex="-1">
      <div class="modal-dialog"><div class="modal-content">
        <form id="form-editar">
          <input type="hidden" name="_id">
          <div class="modal-header">
            <h5 class="modal-title">Editar Pez</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label for="nombre_comun">Nombre com√∫n</label>
              <input id="nombre_comun" name="nombre_comun" type="text"
                     placeholder="Ej. Boquichico" class="form-control" required>
            </div>
            <div class="form-group">
              <label for="nombre_cientifico">Nombre cient√≠fico</label>
              <input id="nombre_cientifico" name="nombre_cientifico" type="text"
                     placeholder="Ej. Prochilodus nigricans" class="form-control" required>
            </div>
            <div class="form-group">
              <label for="familia">Familia</label>
              <input id="familia" name="familia" type="text"
                     placeholder="Ej. Prochilodontidae" class="form-control" required>
            </div>
            <div class="form-group">
              <label for="alimentacion">Alimentaci√≥n</label>
              <input id="alimentacion" name="alimentacion" type="text"
                     placeholder="Ej. Omn√≠vora" class="form-control">
            </div>
            <div class="form-group">
              <label for="estado_conservacion">Estado de conservaci√≥n</label>
              <input id="estado_conservacion" name="estado_conservacion" type="text"
                     placeholder="Ej. Preocupaci√≥n menor" class="form-control">
            </div>
            <div class="form-group">
              <label for="imagen">Imagen</label>
              <input id="imagen" name="imagen" type="file"
                     class="form-control" accept="image/*">
            </div>
            <p id="editar-msg" class="text-error"></p>
          </div>
          <div class="modal-footer">
            <button class="btn btn-warning w-100" type="submit">Actualizar</button>
          </div>
        </form>
      </div></div>
    </div>

    <!-- Modal Eliminar Pez -->
    <div class="modal fade" id="modalEliminar" tabindex="-1">
      <div class="modal-dialog"><div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Eliminar Pez</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="idEliminar">
          <p>¬øSeguro que deseas eliminar <strong id="pezAEliminar"></strong>?</p>
        </div>
        <div class="modal-footer">
          <button id="confirmar-eliminar" class="btn btn-danger w-100">Eliminar</button>
        </div>
      </div></div>
    </div>

    <h3 class="text-success mt-4">Especies actuales</h3>
    <div class="row" id="admin-contenedor-peces"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const baseURL = location.origin;
    const rol     = sessionStorage.getItem('rol') || 'invitado';

    if (!['admin','analista'].includes(rol)) {
      location.replace('peces.html');
    }
    if (rol !== 'admin') {
      document.getElementById('btn-agregar').style.display = 'none';
    }
    document.getElementById('btn-logout')
      .addEventListener('click', () => {
        sessionStorage.clear();
        location.replace('peces.html');
      });

    function resolverImagen(url) {
      if (!url) return `${baseURL}/images/default.png`;
      return url.startsWith('http') ? url
           : url.startsWith('/') ? baseURL + url
           : `${baseURL}/images/${url}`;
    }

    function renderEspecies(especies) {
      const cont = document.getElementById('admin-contenedor-peces');
      cont.innerHTML = '';
      especies.forEach(p => {
        const imgUrl = resolverImagen(p.imagen_url);
        cont.insertAdjacentHTML('beforeend', `
          <div class="col-md-4 mb-4">
            <div class="card shadow-sm h-100">
              <img src="${imgUrl}" class="card-img-top" alt="${p.nombre_comun}">
              <div class="card-body">
                <h5>${p.nombre_comun}</h5>
                <button class="btn btn-warning btn-custom me-2"
                        onclick="abrirEditar('${p._id}')">
                  <i class="bi bi-pencil"></i> Editar
                </button>
                ${ rol==='admin'
                  ? `<button class="btn btn-danger btn-custom"
                              onclick="abrirEliminar('${p._id}','${p.nombre_comun}')">
                       <i class="bi bi-trash"></i> Eliminar
                     </button>`
                  : '' }
              </div>
            </div>
          </div>
        `);
      });
    }

    async function cargarPanel() {
      try {
        const res = await fetch(`${baseURL}/especies`);
        if (!res.ok) throw '';
        const data = await res.json();
        renderEspecies(data);
      } catch {
        document.getElementById('admin-contenedor-peces').innerHTML =
          `<p class="text-danger text-center">Error al cargar las especies.</p>`;
      }
    }

    window.abrirEditar = async id => {
      const res = await fetch(`${baseURL}/especies`);
      const peces = await res.json();
      const p = peces.find(x => x._id === id);
      const f = document.getElementById('form-editar');
      f._id.value                  = p._id;
      f.nombre_comun.value         = p.nombre_comun;
      f.nombre_cientifico.value    = p.nombre_cientifico;
      f.familia.value              = p.familia;
      f.alimentacion.value         = p.alimentacion || '';
      f.estado_conservacion.value  = p.estado_conservacion || '';
      new bootstrap.Modal(document.getElementById('modalEditar')).show();
    };

    document.getElementById('form-editar')
      .addEventListener('submit', async e => {
        e.preventDefault();
        const f = e.target;
        const payload = {
          nombre_comun:       f.nombre_comun.value,
          nombre_cientifico:  f.nombre_cientifico.value,
          familia:            f.familia.value,
          alimentacion:       f.alimentacion.value,
          estado_conservacion:f.estado_conservacion.value
        };
        try {
          const res = await fetch(
            `${baseURL}/especies/${f._id.value}`,
            {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            }
          );
          const data = await res.json();
          if (!res.ok) {
            document.getElementById('editar-msg').textContent = data.message;
            console.error('Error al actualizar:', data.code, data.message);
            return;
          }
          bootstrap.Modal.getInstance(document.getElementById('modalEditar')).hide();
          cargarPanel();
        } catch (err) {
          console.error('Fetch fall√≥:', err);
          document.getElementById('editar-msg').textContent = 'Error de red. Intenta de nuevo.';
        }
      });

    window.abrirEliminar = (id, nombre) => {
      document.getElementById('idEliminar').value = id;
      document.getElementById('pezAEliminar').textContent = nombre;
      new bootstrap.Modal(document.getElementById('modalEliminar')).show();
    };

    document.getElementById('confirmar-eliminar')
      .addEventListener('click', async () => {
        try {
          await fetch(
            `${baseURL}/especies/${document.getElementById('idEliminar').value}`,
            { method: 'DELETE' }
          );
          bootstrap.Modal.getInstance(document.getElementById('modalEliminar')).hide();
          cargarPanel();
        } catch {}
      });

    document.getElementById('form-agregar')
      .addEventListener('submit', async e => {
        e.preventDefault();
        const fd = new FormData(e.target);
        try {
          const res = await fetch(
            `${baseURL}/especies`,
            { method: 'POST', body: fd }
          );
          if (!res.ok) throw '';
          bootstrap.Modal.getInstance(document.getElementById('modalAgregarPez')).hide();
          e.target.reset();
          cargarPanel();
        } catch {
          document.getElementById('agregar-msg').textContent = 'Error al agregar pez';
        }
      });

    window.onload = cargarPanel;
  </script>
</body>
</html>


