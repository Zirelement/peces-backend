<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel de Administraci√≥n</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/jsencrypt/bin/jsencrypt.min.js"></script>
  <style>
    body { background-color: #f8f9fa; }
    .card-img-top { height: 200px; object-fit: contain; }
    .btn-custom { transition: all 0.3s ease-in-out; border-radius: 8px; }
    .btn-custom:hover { transform: scale(1.05); box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15); }
    .btn-success { background-color: #198754; border-color: #198754; }
    .btn-danger { background-color: #dc3545; border-color: #dc3545; }
    .btn-warning { background-color: #ffc107; border-color: #ffc107; }
    .top-buttons { display: flex; justify-content: space-between; margin-bottom: 10px; }
  </style>
</head>
<body class="bg-light">

<div class="container mt-4">
  <div class="top-buttons">
    <a href="peces.html" class="btn btn-outline-primary btn-custom">‚Üê Regresar a galer√≠a</a>
    <button onclick="logout()" class="btn btn-outline-danger btn-custom">Cerrar sesi√≥n</button>
  </div>

  <h1 class="text-center text-success mb-4">Panel de Administraci√≥n üõ†Ô∏è</h1>
  <div class="text-center mb-3">
    <button id="btn-agregar" class="btn btn-success btn-custom" data-bs-toggle="modal" data-bs-target="#modalAgregarPez">+ Agregar nuevo pez</button>
  </div>

  <!-- Modales -->
  <!-- (sin cambios en los modales) -->

  <h3 class="text-success mt-4">Especies actuales</h3>
  <div class="row" id="admin-contenedor-peces"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const baseURL = location.origin;
  const userRole = localStorage.getItem('userRole');
  if (!userRole) location.href = 'peces.html';
  if (userRole === 'admin') document.getElementById('btn-agregar').style.display = 'inline-block';

  function logout() {
    localStorage.removeItem('userRole');
    location.href = 'peces.html';
  }

  async function cargarPeces() {
    const cont = document.getElementById('admin-contenedor-peces');
    cont.innerHTML = '';
    try {
      const res = await fetch(`${baseURL}/especies`);
      const peces = await res.json();
      peces.forEach(p => {
        const imgSrc = p.imagen_url.startsWith('http') ? p.imagen_url : `${baseURL}/images/${p.imagen_url}`;
        cont.innerHTML += `
          <div class="col-md-4 mb-4">
            <div class="card h-100 shadow-sm">
              <img src="${imgSrc}" class="card-img-top" alt="${p.nombre_comun}">
              <div class="card-body">
                <h5 class="card-title">${p.nombre_comun}</h5>
                <p class="card-text">
                  <strong>Cient√≠fico:</strong> ${p.nombre_cientifico}<br>
                  <strong>Familia:</strong> ${p.familia}<br>
                  <strong>Alimentaci√≥n:</strong> ${p.alimentacion || '-'}<br>
                  <strong>Conservaci√≥n:</strong> ${p.estado_conservacion || '-'}
                </p>
                ${userRole === 'admin' || userRole === 'analista' ? `<button class="btn btn-warning btn-sm me-2" onclick='abrirEditar(${JSON.stringify(p)})'>Editar</button>` : ''}
                ${userRole === 'admin' ? `<button class="btn btn-danger btn-sm" onclick="abrirEliminar('${p._id}','${p.nombre_comun}')">Eliminar</button>` : ''}
              </div>
            </div>
          </div>`;
      });
    } catch (err) {
      console.error('Error GET /especies', err);
      document.getElementById('admin-contenedor-peces').innerHTML = '<p class="text-danger">Error al cargar especies.</p>';
    }
  }

  // Agregar pez
  document.getElementById('form-agregar').addEventListener('submit', async e => {
    e.preventDefault();
    const fd = new FormData(e.target);
    try {
      const res = await fetch(`${baseURL}/especies`, { method: 'POST', body: fd });
      if (!res.ok) throw new Error('No se cre√≥');
      bootstrap.Modal.getInstance(document.getElementById('modalAgregarPez')).hide();
      e.target.reset();
      cargarPeces();
    } catch (err) {
      console.error('Error POST /especies', err);
      document.getElementById('agregar-msg').textContent = 'Error al agregar pez';
    }
  });

  // Editar pez
  function abrirEditar(p) {
    const f = document.getElementById('form-editar');
    f._id.value = p._id;
    f.nombre_comun.value = p.nombre_comun;
    f.nombre_cientifico.value = p.nombre_cientifico;
    f.familia.value = p.familia;
    f.alimentacion.value = p.alimentacion;
    f.estado_conservacion.value = p.estado_conservacion;
    new bootstrap.Modal(document.getElementById('modalEditar')).show();
  }
  document.getElementById('form-editar').addEventListener('submit', async e => {
    e.preventDefault();
    const f = e.target;
    const id = f._id.value;
    const fd = new FormData(f);
    try {
      const res = await fetch(`${baseURL}/especies/${id}`, { method: 'PUT', body: fd });
      if (!res.ok) throw new Error('No se actualiz√≥');
      bootstrap.Modal.getInstance(document.getElementById('modalEditar')).hide();
      cargarPeces();
    } catch (err) {
      console.error('Error PUT /especies', err);
      document.getElementById('editar-msg').textContent = 'Error al actualizar';
    }
  });

  // Eliminar pez
  function abrirEliminar(id, nombre) {
    document.getElementById('idEliminar').value = id;
    document.getElementById('pezAEliminar').textContent = nombre;
    new bootstrap.Modal(document.getElementById('modalEliminar')).show();
  }
  document.getElementById('confirmar-eliminar').addEventListener('click', async () => {
    const id = document.getElementById('idEliminar').value;
    try {
      const res = await fetch(`${baseURL}/especies/${id}`, { method: 'DELETE' });
      if (res.ok) cargarPeces();
      bootstrap.Modal.getInstance(document.getElementById('modalEliminar')).hide();
    } catch (err) {
      console.error('Error DELETE /especies', err);
    }
  });

  window.onload = cargarPeces;
</script>
</body>
</html>


